// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  PROVIDER
  ADMIN
  SUPERADMIN
}

enum BookingStatus {
  CANCELLED
  PENDING
  CONFIRMED
}

enum NotificationChannel {
  EMAIL
  SMS
}

enum NotificationKind {
  BOOKING_CONFIRMATION
  REMINDER_24H
  REMINDER_2H
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

model User {
  UserId String @id @default(uuid())
  email String @unique
  name String?
  slug String? @unique
  passwordHash String?
  role Role @default(CUSTOMER)
  services Service[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  timezone String @default("America/Edmonton")
  availability AvailabilityRules[]
  timeOff TimeOff[]
}

model AvailabilityRules {
  id String @id @default(uuid())
  provider User @relation(references: [UserId], fields: [providerId])
  providerId String
  weekday Int
  startLocal String
  endLocal String
  slotMins Int @default(60)
}

model TimeOff {
  id String @id @default(uuid())
  startTimeUtc DateTime
  endTimeUtc DateTime
  reason String?
  provider User @relation(references: [UserId], fields: [providerId])
  providerId String
}

model Service {
  id String @id @default(uuid())
  title String
  slug String
  description String?
  price Float @default(0)
  imageUrl String?
  providerId String
  provider User @relation(fields: [providerId], references: [UserId], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  defaultDurationMins Int? @default(60)
  cancellationPolicyHours Int @default(24)

  Booking Booking[]
  @@unique([providerId, slug])
}

model Booking {
  id String @id @default(uuid())
  service Service @relation(fields: [serviceId], references: [id])
  serviceId String
  startAt DateTime
  endAt DateTime?
  status BookingStatus @default(PENDING)
  customerName String
  customerEmail String
  customerPhone String?
  notes String?
  createdAt DateTime @default(now())
  idempotencyKey String? @unique
  manageToken String? @unique
  cancelledAt DateTime?
  cancellationReason String?

  @@index([serviceId, startAt])
  @@index([serviceId, endAt])
  Notification Notification[]
}

model Notification {
  id String @id @default(uuid())
  bookingId String
  booking Booking @relation(fields: [bookingId], references: [id])
  channel NotificationChannel
  kind NotificationKind
  to String
  runAt DateTime
  sentAt DateTime?
  status NotificationStatus @default(PENDING)
  attempts Int @default(0)
  lastError String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([bookingId, channel, kind])
  @@index([status, runAt])
}


